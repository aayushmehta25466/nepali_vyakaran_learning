version: "3.9"

services:
  # Redis
  redis:
    image: redis:7-alpine
    container_name: nepali_redis
    volumes:
      - redis_data:/data
    networks:
      - nepali_network
    restart: unless-stopped

  # Django Backend (API → 4005)
  backend:
    build:
      context: ./Backend/nepali_vyakaran_learning
      dockerfile: Dockerfile
    container_name: nepali_backend
    command: >
      sh -c "
      python manage.py migrate &&
      python manage.py collectstatic --noinput &&
      gunicorn nepali_vyakaran_learning.wsgi:application
      --bind 0.0.0.0:8000
      --workers 2
      --threads 1
      --timeout 60
      "
    environment:
      DEBUG: "True"
      SECRET_KEY: "dev-secret-key"
      ALLOWED_HOSTS: "localhost,127.0.0.1,backend,nginx"
      REDIS_URL: redis://redis:6379/0
    volumes:
      - ./Backend/nepali_vyakaran_learning:/app
      - sqlite_data:/app/db
      - backend_static:/app/staticfiles
      - backend_media:/app/media
    ports:
      - "4005:8000"
    depends_on:
      - redis
    networks:
      - nepali_network
    restart: unless-stopped

  # React Frontend (UI → 8005)
  frontend:
    build:
      context: ./Frontend/-_-
      dockerfile: Dockerfile
    container_name: nepali_frontend
    environment:
      REACT_APP_API_URL: http://localhost:4005
      REACT_APP_API_BASE_PATH: /api/v1
    ports:
      - "8005:3000"
    networks:
      - nepali_network
    restart: unless-stopped

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: nepali_nginx
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - backend_static:/app/staticfiles:ro
      - backend_media:/app/media:ro
    ports:
      - "8005:80"
    depends_on:
      - backend
      - frontend
    networks:
      - nepali_network
    restart: unless-stopped

volumes:
  redis_data:
  sqlite_data:
  backend_static:
  backend_media:

networks:
  nepali_network:
    driver: bridge
